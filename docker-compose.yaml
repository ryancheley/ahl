version: '3.8'

services:
  django:
    image: python:3.11-slim
    working_dir: /app
    command: >
      sh -c "ls -la &&
             pip install --no-cache-dir gunicorn django django-extensions &&
             pip install --no-cache-dir uv &&
             uv pip install --system -r requirements.txt &&
             python manage.py migrate --noinput &&
             python manage.py collectstatic --noinput &&
             gunicorn --bind 0.0.0.0:8000 core.wsgi:application"
    environment:
      - DEBUG=off
      - SECRET_KEY=${SECRET_KEY}
      - ALLOWED_HOSTS=${SERVICE_FQDN_DJANGO}
      - CSRF_TRUSTED_ORIGINS=${SERVICE_URL_DJANGO}
      - SECURE_PROXY_SSL_HEADER=HTTP_X_FORWARDED_PROTO,https
      - DATABASE_URL=sqlite:///app/db.sqlite3
    volumes:
      - .:/app
    networks:
      - coolify
    restart: unless-stopped
    expose:
      - "8000"

  datasette:
    image: datasetteproject/datasette:latest
    command: datasette --host 0.0.0.0 --port 8001 --metadata metadata.yaml games.db
    environment:
      - PUBLIC_URL=${SERVICE_URL_DATASETTE}
    networks:
      - coolify
    restart: unless-stopped
    expose:
      - "8001"

networks:
  coolify:
    external: true
    name: coolify