version: '3.8'

services:
  django:
    build:
      context: .
      dockerfile: Dockerfile.coolify
    environment:
      - DEBUG=off
      - SECRET_KEY=${SECRET_KEY}
      - ALLOWED_HOSTS=${SERVICE_FQDN_DJANGO}
      - CSRF_TRUSTED_ORIGINS=${SERVICE_URL_DJANGO}
      - SECURE_PROXY_SSL_HEADER=HTTP_X_FORWARDED_PROTO,https
      - DATABASE_NAME=/app/db.sqlite3
      - GAMES_DATABASE_NAME=/app/games.db
    volumes:
      - ./db.sqlite3:/app/db.sqlite3
      - ./games.db:/app/games.db
    ports:
      - "8000:8000"
    networks:
      - coolify
    restart: unless-stopped
    command: gunicorn --bind 0.0.0.0:8000 core.wsgi:application

  datasette:
    build:
      context: .
      dockerfile: Dockerfile.datasette.coolify
    environment:
      - PUBLIC_URL=${SERVICE_URL_DATASETTE}
    volumes:
      - ./games.db:/app/games.db
    networks:
      - coolify
    restart: unless-stopped
    command: datasette --host 0.0.0.0 --port 8001

networks:
  coolify:
    external: true
    name: coolify